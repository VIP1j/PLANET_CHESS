<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Planet_Chess | Official</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-database-compat.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>

    <style>
        :root { --accent: #00d4ff; --neon: #39ff14; --bg: #0b0b14; }
        * { touch-action: manipulation; box-sizing: border-box; }
        body { background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; text-align: center; overflow: hidden; height: 100vh; display: flex; align-items: center; justify-content: center; }
        .screen { display: none; width: 100%; max-width: 420px; padding: 15px; height: 100%; flex-direction: column; justify-content: center; overflow-y: auto; }
        .active { display: flex; animation: fadeIn 0.3s; }
        #board-wrapper { position: relative; width: 100%; max-width: 400px; margin: auto; }
        #board { width: 100%; border: 3px solid var(--accent); border-radius: 5px; box-shadow: 0 0 15px rgba(0,212,255,0.2); }
        #promotion-menu { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.95); border: 2px solid var(--neon); padding: 15px; border-radius: 12px; z-index: 1000; }
        .prom-btn { background: #222; border: 1px solid var(--accent); color: white; padding: 15px; margin: 5px; cursor: pointer; border-radius: 8px; font-size: 24px; }
        .btn { background: rgba(255,255,255,0.05); border: 1px solid var(--accent); color: white; padding: 12px; margin: 5px 0; border-radius: 10px; cursor: pointer; font-weight: bold; width: 100%; font-size: 14px; text-transform: uppercase; }
        .timer-box { display: flex; justify-content: space-between; padding: 8px 12px; background: #161625; border-radius: 8px; margin: 5px 0; color: var(--neon); font-family: monospace; font-size: 18px; border: 1px solid #333; }
        .stats-box { background: rgba(255,255,255,0.08); padding: 12px; border-radius: 15px; border-left: 4px solid var(--neon); text-align: left; margin-bottom: 10px; }
        input, select { width: 100%; padding: 10px; margin: 5px 0; border-radius: 8px; background: #000; color: #fff; border: 1px solid #444; }
        .list-box { background: #161625; border-radius: 10px; padding: 8px; max-height: 150px; overflow-y: auto; border: 1px solid #333; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div id="loading-screen" class="screen active"><h2>ü™ê –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø...</h2></div>

    <div id="auth-screen" class="screen">
        <h1 style="color:var(--accent)">Planet_Chess</h1>
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="pass" placeholder="–ü–∞—Ä–æ–ª—å">
        <button class="btn" onclick="authAction('login')">–£–í–Ü–ô–¢–ò</button>
        <button class="btn" onclick="authAction('reg')">–†–ï–Ñ–°–¢–†–ê–¶–Ü–Ø</button>
    </div>

    <div id="menu-screen" class="screen">
        <div class="stats-box">
            <b id="u-name">–ì—Ä–∞–≤–µ—Ü—å</b><br>
            <small>üåê PvP: <b id="r-pvp" style="color:var(--accent)">100</b> | ü§ñ Bot: <b id="r-bot" style="color:var(--neon)">100</b></small>
        </div>
        <select id="time-limit">
            <option value="60">1 —Ö–≤</option>
            <option value="180" selected>3 —Ö–≤</option>
            <option value="600">10 —Ö–≤</option>
        </select>
        <button class="btn" onclick="startSearch()">üåê –ì–†–ê–¢–ò (PVP)</button>
        <button class="btn" onclick="$('.friend-box').toggle()">ü§ù –ì–†–ê–¢–ò –ó –î–†–£–ì–û–ú</button>
        <div class="friend-box" style="display:none; background: #111; padding: 10px; border-radius: 10px;">
            <button class="btn" onclick="friendRoom('create')">–°—Ç–≤–æ—Ä–∏—Ç–∏ –∫–æ–¥</button>
            <input type="text" id="join-id" placeholder="–ö–æ–¥">
            <button class="btn" onclick="friendRoom('join')">–£–≤—ñ–π—Ç–∏</button>
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:5px;">
            <button class="btn" onclick="startBot(1, '–ú–∞—Ä–∏–∫')">–ú–∞—Ä–∏–∫</button>
            <button class="btn" onclick="startBot(10, '–ö—É–∫—É–∑—è–±–∞')">–ö—É–∫–∑—è</button>
            <button class="btn" onclick="startBot(20, '–®–æ–Ω—è')">–®–æ–Ω—è</button>
        </div>
        <button class="btn" onclick="showLB()">üèÜ –õ–Ü–î–ï–†–ò</button>
        <button class="btn" onclick="showScreen('profile-screen')">üë§ –ü–†–û–§–Ü–õ–¨</button>
    </div>

    <div id="game-screen" class="screen">
        <div class="timer-box"><span id="opp-nick">–ü–æ—à—É–∫...</span><span id="opp-time">--:--</span></div>
        <div id="board-wrapper">
            <div id="board"></div>
            <div id="promotion-menu">
                <button class="prom-btn" onclick="promoteTo('q')">‚ôõ</button>
                <button class="prom-btn" onclick="promoteTo('r')">‚ôú</button>
                <button class="prom-btn" onclick="promoteTo('b')">‚ôù</button>
                <button class="prom-btn" onclick="promoteTo('n')">‚ôû</button>
            </div>
        </div>
        <div class="timer-box"><span id="my-nick">–í–∏</span><span id="my-time">--:--</span></div>
        <div id="game-controls"></div>
    </div>

    <div id="profile-screen" class="screen">
        <h3>–ê—Ä—Ö—ñ–≤ —Ç–∞ –ù—ñ–∫</h3>
        <input type="text" id="new-nick" placeholder="–ù–æ–≤–∏–π –Ω—ñ–∫">
        <button class="btn" onclick="updateNick()">–ó–ú–Ü–ù–ò–¢–ò –ù–Ü–ö</button>
        <div id="archive-list" class="list-box" style="margin-top:10px;"></div>
        <button class="btn" onclick="showScreen('menu-screen')" style="margin-top:10px;">–ù–ê–ó–ê–î</button>
    </div>

    <script>
        const firebaseConfig = { 
            apiKey: "AIzaSyAmkBLeoloxgLRGzClkQ21HQ2GEahFQxKM",
            databaseURL: "https://hrrthrth-default-rtdb.firebaseio.com",
            projectId: "hrrthrth",
            appId: "1:4650088854:web:15855662c2259e531dc5b7"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database(), auth = firebase.auth();

        let game = new Chess(), board = null, userData = {}, myColor = 'w', roomId = null, isPvP = false, gameActive = false, mySec, oppSec, timerInterval = null, pendingMove = null;

        function authAction(t) {
            const e = $('#email').val(), p = $('#pass').val();
            if(t==='reg') {
                auth.createUserWithEmailAndPassword(e,p).then(u => {
                    db.ref('users/'+u.user.uid).set({nick: e.split('@')[0], rPvP: 100, rBot: 100, lastNickChange: 0});
                }).catch(err => alert(err.message));
            } else auth.signInWithEmailAndPassword(e,p).catch(err => alert(err.message));
        }

        auth.onAuthStateChanged(user => {
            if(user) {
                db.ref('users/'+user.uid).on('value', s => {
                    userData = s.val() || {};
                    $('#u-name, #my-nick').text(userData.nick);
                    $('#r-pvp').text(userData.rPvP); $('#r-bot').text(userData.rBot);
                    showScreen('menu-screen'); loadHistory();
                });
            } else showScreen('auth-screen');
        });

        function startSearch() {
            isPvP = true; gameActive = false; showScreen('game-screen'); setButtons(false);
            const timeLimit = $('#time-limit').val();
            const qPath = 'queue_' + timeLimit;

            db.ref(qPath).transaction(q => (q === auth.currentUser.uid) ? q : (q ? null : auth.currentUser.uid), (err, comm, s) => {
                let res = s.val();
                if (res === auth.currentUser.uid) {
                    roomId = auth.currentUser.uid; myColor = 'w';
                    db.ref('rooms/'+roomId).set({p1:auth.currentUser.uid, p1N:userData.nick, p1R:userData.rPvP, fen:'start', status:'wait', time:timeLimit});
                    db.ref('rooms/'+roomId).onDisconnect().remove();
                } else {
                    roomId = res; myColor = 'b';
                    db.ref('rooms/'+roomId).update({p2:auth.currentUser.uid, p2N:userData.nick, p2R:userData.rPvP, status:'play'});
                }
                initBoard();
            });
        }

        function initBoard() {
            board = Chessboard('board', {
                draggable: true, position: 'start', orientation: myColor === 'w' ? 'white' : 'black',
                pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png',
                onDrop: (s, t) => {
                    if(!gameActive || game.turn() !== myColor[0]) return 'snapback';
                    let test = game.move({from: s, to: t, promotion: 'q'});
                    if (!test) return 'snapback';
                    game.undo();
                    let p = game.get(s);
                    if (p && p.type === 'p' && ((p.color === 'w' && t[1] === '8') || (p.color === 'b' && t[1] === '1'))) {
                        pendingMove = { from: s, to: t }; $('#promotion-menu').show(); return;
                    }
                    game.move({from: s, to: t, promotion: 'q'}); updateAfterMove();
                }
            });

            if(isPvP) {
                db.ref('rooms/'+roomId).on('value', s => {
                    let d = s.val(); if(!d) return;
                    if(d.status === 'finish') { db.ref('rooms/'+roomId).off(); alert(d.msg); location.reload(); return; }
                    if(d.status === 'play' && !gameActive) { gameActive = true; setButtons(true); mySec = d.time; oppSec = d.time; startT(); }
                    if(d.status === 'resigned') handleEnd(false, d.winner !== auth.currentUser.uid ? false : true, "–°–£–ü–ï–†–ù–ò–ö –ó–î–ê–í–°–Ø");
                    if(myColor==='w' && d.p2N) $('#opp-nick').text(d.p2N);
                    if(myColor==='b') $('#opp-nick').text(d.p1N);
                    if(d.fen !== game.fen()) { game.load(d.fen); board.position(d.fen); if(game.game_over()) handleEnd(); }
                });
            }
        }

        function promoteTo(type) { $('#promotion-menu').hide(); if (pendingMove) { game.move({ from: pendingMove.from, to: pendingMove.to, promotion: type }); pendingMove = null; updateAfterMove(); } }

        function updateAfterMove() {
            board.position(game.fen());
            if(isPvP) db.ref('rooms/'+roomId).update({fen: game.fen()});
            else { if(game.game_over()) handleEnd(); else setTimeout(makeBotMove, 500); }
        }

        function setButtons(active) {
            $('#game-controls').html(active ? `<button class="btn" onclick="resign()" style="color:#ff4444">üè≥Ô∏è –ó–¥–∞—Ç–∏—Å—è</button>` : `<button class="btn" onclick="location.reload()">üîô –°–∫–∞—Å—É–≤–∞—Ç–∏</button>`);
        }

        function resign() { if(confirm("–ó–¥–∞—Ç–∏—Å—è?")) db.ref('rooms/'+roomId).update({status:'resigned', winner: (myColor==='w' ? 'p2' : 'p1')}); }

        function handleEnd(draw = false, forceWin = null, reason = "") {
            clearInterval(timerInterval);
            if (!gameActive && isPvP) return;
            gameActive = false;
            let isWin = forceWin !== null ? forceWin : (game.in_checkmate() && game.turn() !== myColor[0]);
            let txt = reason || (isWin ? "–ú–ê–¢! –ü–ï–†–ï–ú–û–ì–ê" : (game.in_draw() ? "–ù–Ü–ß–ò–Ø" : "–ü–û–†–ê–ó–ö–ê"));
            db.ref('users/'+auth.currentUser.uid).update({ [isPvP?'rPvP':'rBot']: Math.max(0, (userData[isPvP?'rPvP':'rBot']||100) + (isWin?5:-6)) });
            if(isPvP) db.ref('rooms/'+roomId).update({ status: 'finish', msg: txt }).then(() => { alert(txt); location.reload(); });
            else { alert(txt); location.reload(); }
        }

        function startT() {
            timerInterval = setInterval(() => {
                if(game.turn() === myColor[0]) { mySec--; if(mySec<=0) handleEnd(false, false, "–ß–∞—Å –≤–∏—á–µ—Ä–ø–∞–Ω–æ!"); }
                else { oppSec--; if(oppSec<=0) handleEnd(false, true, "–ß–∞—Å —Å—É–ø–µ—Ä–Ω–∏–∫–∞ –≤–∏–π—à–æ–≤!"); }
                $('#my-time').text(fmt(mySec)); $('#opp-time').text(fmt(oppSec));
            }, 1000);
        }

        function fmt(s) { return Math.floor(s/60).toString().padStart(2,'0')+":"+(s%60).toString().padStart(2,'0'); }
        function showScreen(id) { $('.screen').removeClass('active'); $('#'+id).addClass('active'); }
        function showLB() { db.ref('users').once('value', s => { let u = Object.values(s.val() || {}); alert("TOP PvP:\n"+u.sort((a,b)=>b.rPvP-a.rPvP).slice(0,5).map(x=>x.nick+': '+x.rPvP).join('\n')); }); }
        function startBot(l, n) { isPvP = false; gameActive = true; showScreen('game-screen'); $('#opp-nick').text(n); initBoard(); setButtons(true); }
        function makeBotMove() { let m = game.moves(); if(m.length) { game.move(m[Math.floor(Math.random()*m.length)]); board.position(game.fen()); if(game.game_over()) handleEnd(); } }
        function loadHistory() { db.ref('users/'+auth.currentUser.uid+'/archive').limitToLast(5).once('value', s => { let h = ""; s.forEach(x => { let v = x.val(); h += `<div style="font-size:12px; padding:5px; border-bottom:1px solid #222">${v.opp} - ${v.res}</div>`; }); $('#archive-list').html(h || "–ê—Ä—Ö—ñ–≤ –ø–æ—Ä–æ–∂–Ω—ñ–π"); }); }
        function updateNick() { let n = $('#new-nick').val(); if(n.length>2) db.ref('users/'+auth.currentUser.uid).update({nick:n}); }
        function friendRoom(m) { isPvP = true; showScreen('game-screen'); if(m==='create') { roomId=Math.floor(1000+Math.random()*9000); myColor='w'; db.ref('rooms/'+roomId).set({p1:auth.currentUser.uid, p1N:userData.nick, p1R:userData.rPvP, fen:'start', status:'wait', time:$('#time-limit').val()}); alert("–ö–û–î: "+roomId); } else { roomId=$('#join-id').val(); myColor='b'; db.ref('rooms/'+roomId).update({p2:auth.currentUser.uid, p2N:userData.nick, p2R:userData.rPvP, status:'play'}); } initBoard(); }
    </script>
</body>
</html>