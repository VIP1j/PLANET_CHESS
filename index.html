<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Planet_Chess | Mobile Fortress</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-database-compat.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui-touch-punch/0.2.3/jquery.ui.touch-punch.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>

    <style>
        :root { --accent: #00d4ff; --neon: #39ff14; --bg: #0b0b14; }
        body { background: var(--bg); color: white; font-family: sans-serif; margin: 0; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
        .screen { display: none; width: 100%; max-width: 500px; padding: 15px; margin: auto; flex-direction: column; min-height: 100vh; box-sizing: border-box; }
        .active { display: flex !important; }
        
        /* –î–æ—à–∫–∞ */
        #board { width: 100%; margin: 10px auto; border: 3px solid var(--accent); border-radius: 8px; touch-action: none; }
        
        /* –ö–Ω–æ–ø–∫–∏ —Ç–∞ —ñ–Ω–ø—É—Ç–∏ */
        .btn { background: rgba(255,255,255,0.05); border: 1px solid var(--accent); color: white; padding: 16px; margin: 6px 0; border-radius: 14px; cursor: pointer; font-weight: bold; width: 100%; font-size: 16px; transition: 0.2s; }
        .btn:active { background: var(--accent); color: black; transform: scale(0.98); }
        input, select { width: 100%; padding: 15px; margin: 8px 0; border-radius: 12px; background: #111; color: #fff; border: 1px solid #444; font-size: 16px; box-sizing: border-box; }
        
        /* –Ü–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≥—Ä–∏ */
        .timer-box { display: flex; justify-content: space-between; padding: 12px; background: #161625; border-radius: 10px; color: var(--neon); font-family: monospace; font-size: 22px; margin-bottom: 5px; border: 1px solid #333; }
        .stats-box { background: rgba(255,255,255,0.08); padding: 15px; border-radius: 15px; border-left: 5px solid var(--neon); text-align: left; margin-bottom: 15px; }
        .bot-tab { display: none; background: #000; padding: 10px; border-radius: 12px; border: 1px dashed var(--accent); margin-top: 5px; }
        .archive-list { background: #161625; border-radius: 10px; padding: 10px; max-height: 150px; overflow-y: auto; text-align: left; font-size: 13px; border: 1px solid #333; }

        /* –ü–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø—ñ—à–∞–∫–∞ */
        #promotion-dialog { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #161625; padding: 25px; border: 3px solid var(--accent); border-radius: 20px; z-index: 1000; text-align: center; box-shadow: 0 0 50px #000; }
        #promotion-dialog button { width: 70px; height: 70px; font-size: 35px; margin: 5px; cursor: pointer; background: #000; color: white; border: 1px solid #444; border-radius: 15px; }
        
        #auth-error { color: #ff4444; font-size: 13px; margin-top: 10px; text-align: center; min-height: 20px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="promotion-dialog">
        <p style="margin-bottom:15px; font-weight:bold;">–û–±–µ—Ä—ñ—Ç—å —Ñ—ñ–≥—É—Ä—É:</p>
        <button onclick="makePromotion('q')">‚ôï</button>
        <button onclick="makePromotion('r')">‚ôñ</button><br>
        <button onclick="makePromotion('b')">‚ôó</button>
        <button onclick="makePromotion('n')">‚ôò</button>
    </div>

    <div id="auth-screen" class="screen active">
        <h1 style="color:var(--accent); text-align:center; margin-top:40px;">Planet_Chess</h1>
        <p style="text-align:center; opacity:0.7;">–ê–∫–∞—É–Ω—Ç-—Ñ–æ—Ä—Ç–µ—Ü—è: –≤—Ö—ñ–¥ –∞–±–æ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</p>
        <input type="email" id="email" placeholder="Email (–Ω–∞–ø—Ä. user@mail.com)" autocomplete="email">
        <input type="password" id="pass" placeholder="–ü–∞—Ä–æ–ª—å (–≤—ñ–¥ 6 —Å–∏–º–≤–æ–ª—ñ–≤)">
        
        <button class="btn" onclick="authAction('login')" style="background: var(--accent); color: black;">–£–í–Ü–ô–¢–ò</button>
        <button class="btn" onclick="authAction('reg')" style="border-color:var(--neon)">–†–ï–Ñ–°–¢–†–ê–¶–Ü–Ø</button>
        
        <div id="auth-error"></div>
    </div>

    <div id="menu-screen" class="screen">
        <div class="stats-box">
            <b id="u-name" style="font-size:20px;">...</b><br>
            <div style="margin-top:8px;">üåê PvP: <b id="r-pvp">100</b> | ü§ñ –ë–æ—Ç: <b id="r-bot">100</b></div>
        </div>
        
        <label style="font-size:14px; margin-left:5px;">–ß–∞—Å –≥—Ä–∏:</label>
        <select id="time-select">
            <option value="60">1 —Ö–≤–∏–ª–∏–Ω–∞</option>
            <option value="180" selected>3 —Ö–≤–∏–ª–∏–Ω–∏</option>
            <option value="600">10 —Ö–≤–∏–ª–∏–Ω</option>
        </select>

        <button class="btn" onclick="startSearch()">üåê –ì–†–ê–¢–ò (PvP)</button>
        <button class="btn" onclick="$('.friend-box').toggle()">ü§ù –ì–†–ê –ó –î–†–£–ì–û–ú</button>
        <div class="friend-box" style="display:none; background: #111; padding: 12px; border-radius: 12px; margin-bottom:10px;">
            <button class="btn" onclick="friendRoom('create')">–°—Ç–≤–æ—Ä–∏—Ç–∏ –∫–æ–¥</button>
            <input type="number" id="join-id" placeholder="–í–≤–µ–¥—ñ—Ç—å –∫–æ–¥">
            <button class="btn" onclick="friendRoom('join')">–ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è</button>
        </div>
        
        <button class="btn" onclick="$('.bot-tab').toggle()" style="border-color:var(--neon)">ü§ñ –ì–†–ê –ó –ë–û–¢–ê–ú–ò</button>
        <div class="bot-tab">
            <button class="btn" onclick="startBot('–ú–∞—Ä–∏–∫', 0)">–ú–∞—Ä–∏–∫ (–õ–µ–≥–∫–∏–π)</button>
            <button class="btn" onclick="startBot('–ö—É–∫—É–∑—è–º–±–æ', 1)">–ö—É–∫—É–∑—è–º–±–æ (–°–µ—Ä–µ–¥–Ω—ñ–π)</button>
            <button class="btn" onclick="startBot('–®–æ–Ω—è', 2)">–®–æ–Ω—è (–°–∫–ª–∞–¥–Ω–∏–π)</button>
        </div>

        <button class="btn" onclick="showLB()">üèÜ –õ–Ü–î–ï–†–ë–û–†–î</button>
        <button class="btn" onclick="showScreen('profile-screen')">üë§ –ü–†–û–§–Ü–õ–¨</button>
    </div>

    <div id="game-screen" class="screen">
        <div class="timer-box"><span id="opp-nick">–°—É–ø–µ—Ä–Ω–∏–∫</span><span id="opp-time">--:--</span></div>
        <div id="board"></div>
        <div class="timer-box" style="margin-top:10px; border-color:var(--accent);"><span id="my-nick">–í–∏</span><span id="my-time">--:--</span></div>
        <div id="room-info" style="text-align:center; font-weight:bold; color:var(--accent); min-height:24px;"></div>
        <div id="game-controls"></div>
    </div>

    <div id="profile-screen" class="screen">
        <h3>üë§ –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h3>
        <input type="text" id="new-nick" placeholder="–ù–æ–≤–∏–π –Ω—ñ–∫">
        <button class="btn" onclick="updateNick()">–ó–ú–Ü–ù–ò–¢–ò –ù–Ü–ö</button>
        <h4 style="margin-top:20px;">üìú –Ü—Å—Ç–æ—Ä—ñ—è:</h4>
        <div id="archive-list" class="archive-list">–ü–æ—Ä–æ–∂–Ω—å–æ</div>
        <button class="btn" onclick="showScreen('menu-screen')" style="margin-top:20px;">üîô –ù–ê–ó–ê–î</button>
    </div>

    <script>
        const firebaseConfig = { 
            apiKey: "AIzaSyAmkBLeoloxgLRGzClkQ21HQ2GEahFQxKM",
            databaseURL: "https://hrrthrth-default-rtdb.firebaseio.com",
            projectId: "hrrthrth",
            appId: "1:4650088854:web:15855662c2259e531dc5b7"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database(), auth = firebase.auth();

        let game = new Chess(), board = null, userData = {}, pendingMove = null;
        let myColor = 'w', roomId = null, isPvP = false, gameActive = false, mySec, oppSec, timerInterval = null, botLevel = 0;

        function showScreen(id) { $('.screen').removeClass('active'); $('#'+id).addClass('active'); }

        auth.onAuthStateChanged(user => {
            if(user) {
                db.ref('users/'+user.uid).on('value', s => {
                    userData = s.val() || {};
                    $('#u-name, #my-nick').text(userData.nick || "–ì—Ä–∞–≤–µ—Ü—å");
                    $('#r-pvp').text(userData.rPvP || 100); $('#r-bot').text(userData.rBot || 100);
                    renderArchive(); showScreen('menu-screen');
                });
            } else showScreen('auth-screen');
        });

        function authAction(t) {
            const errDiv = $('#auth-error');
            const e = $('#email').val().trim().toLowerCase();
            const p = $('#pass').val().trim();

            if (!e || !p) return errDiv.text("–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è!");
            if (p.length < 6) return errDiv.text("–ü–∞—Ä–æ–ª—å –≤—ñ–¥ 6 —Å–∏–º–≤–æ–ª—ñ–≤!");
            
            errDiv.text("–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...");

            if (t === 'reg') {
                auth.createUserWithEmailAndPassword(e, p).then(u => {
                    db.ref('users/' + u.user.uid).set({nick: e.split('@')[0], rPvP: 100, rBot: 100, lastNickChange: 0});
                }).catch(err => errDiv.text("–ü–æ–º–∏–ª–∫–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó: " + err.message));
            } else {
                auth.signInWithEmailAndPassword(e, p).catch(err => errDiv.text("–ü–æ–º–∏–ª–∫–∞ –≤—Ö–æ–¥—É: " + err.message));
            }
        }

        function updateNick() {
            let n = $('#new-nick').val().trim(); let now = Date.now();
            if(n.length < 3) return alert("–ó–∞–Ω–∞–¥—Ç–æ –∫–æ—Ä–æ—Ç–∫–∏–π!");
            if(userData.lastNickChange && (now - userData.lastNickChange < 2592000000)) return alert("–†–∞–∑ –Ω–∞ 30 –¥–Ω—ñ–≤!");
            db.ref('users/'+auth.currentUser.uid).update({nick: n, lastNickChange: now});
        }

        function startSearch() {
            isPvP = true; gameActive = false; showScreen('game-screen');
            let t = $('#time-select').val();
            $('#room-info').text("üîç –ü–æ—à—É–∫...");
            $('#game-controls').html(`<button class="btn" onclick="cancelSearch()">‚ùå –°–ö–ê–°–£–í–ê–¢–ò</button>`);
            db.ref('queue').transaction(q => (q && q !== auth.currentUser.uid) ? null : auth.currentUser.uid, (err, comm, s) => {
                if(s.val() === auth.currentUser.uid) {
                    roomId = auth.currentUser.uid; myColor = 'w';
                    db.ref('rooms/'+roomId).set({p1:auth.currentUser.uid, p1N:userData.nick, status:'wait', fen:'start', time: t});
                } else {
                    roomId = s.val(); myColor = 'b';
                    db.ref('rooms/'+roomId).update({p2:auth.currentUser.uid, p2N:userData.nick, status:'play'});
                }
                initBoard();
            });
        }

        function cancelSearch() {
            if(roomId) db.ref('rooms/'+roomId).remove();
            db.ref('queue').transaction(q => q === auth.currentUser.uid ? null : q);
            showScreen('menu-screen');
        }

        function friendRoom(mode) {
            isPvP = true; gameActive = false; showScreen('game-screen');
            if(mode === 'create') {
                roomId = Math.floor(1000 + Math.random()*9000).toString(); myColor = 'w';
                db.ref('rooms/'+roomId).set({p1:auth.currentUser.uid, p1N:userData.nick, status:'wait', fen:'start', time:$('#time-select').val()});
                $('#room-info').text("–ö–æ–¥: " + roomId);
                $('#game-controls').html(`<button class="btn" onclick="cancelSearch()">‚ùå –ó–ê–ö–†–ò–¢–ò</button>`);
            } else {
                roomId = $('#join-id').val(); myColor = 'b';
                db.ref('rooms/'+roomId).update({p2:auth.currentUser.uid, p2N:userData.nick, status:'play'});
            }
            initBoard();
        }

        function initBoard() {
            game = new Chess();
            board = Chessboard('board', {
                draggable: true, position: 'start', orientation: myColor === 'w' ? 'white' : 'black',
                pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png',
                onDrop: (s, t) => {
                    if(!gameActive || game.turn() !== myColor[0]) return 'snapback';
                    let piece = game.get(s);
                    if(piece && piece.type === 'p' && (t[1] === '8' || t[1] === '1')) {
                        pendingMove = { from: s, to: t };
                        $('#promotion-dialog').show();
                        return 'snapback';
                    }
                    let m = game.move({ from: s, to: t });
                    if(!m) return 'snapback';
                    if(isPvP) db.ref('rooms/'+roomId).update({fen: game.fen()});
                    else { if(game.game_over()) handleEnd(); else setTimeout(makeBotMove, 500); }
                }
            });

            if(isPvP) db.ref('rooms/'+roomId).on('value', s => {
                let d = s.val(); if(!d) return;
                if(d.status==='play' && !gameActive) {
                    gameActive=true; mySec=d.time; oppSec=d.time; startT();
                    $('#opp-nick').text(myColor==='w'?d.p2N:d.p1N);
                    $('#room-info').text("");
                    $('#game-controls').html(`<button class="btn" onclick="handleEnd(false,false)">üè≥Ô∏è –ó–î–ê–¢–ò–°–Ø (-6)</button>`);
                }
                if(d.fen !== game.fen()) { game.load(d.fen); board.position(d.fen); if(game.game_over()) handleEnd(); }
                if(d.status==='finish') { db.ref('rooms/'+roomId).off(); alert(d.msg); showScreen('menu-screen'); }
            });
        }

        function makePromotion(pieceType) {
            $('#promotion-dialog').hide();
            pendingMove.promotion = pieceType;
            game.move(pendingMove);
            board.position(game.fen());
            if(isPvP) db.ref('rooms/'+roomId).update({fen: game.fen()});
            else { if(game.game_over()) handleEnd(); else setTimeout(makeBotMove, 500); }
        }

        function startT() {
            if(timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if(game.turn()===myColor[0]) mySec--; else oppSec--;
                $('#my-time').text(fmt(mySec)); $('#opp-time').text(fmt(oppSec));
                if(mySec<=0) handleEnd(false, false, "–ß–∞—Å –≤–∏–π—à–æ–≤!");
            }, 1000);
        }

        function handleEnd(draw, win, msg) {
            clearInterval(timerInterval); gameActive = false;
            let isWin = win !== undefined ? win : (game.in_checkmate() && game.turn() !== myColor[0]);
            let resTxt = isWin ? "–ü–µ—Ä–µ–º–æ–≥–∞" : "–ü–æ—Ä–∞–∑–∫–∞";
            if(isPvP) {
                db.ref('rooms/'+roomId).update({status:'finish', msg: msg || resTxt});
                db.ref('users/'+auth.currentUser.uid).update({rPvP: Math.max(0, (userData.rPvP||100)+(isWin?4:-6))});
                db.ref('users/'+auth.currentUser.uid+'/archive').push({opp:$('#opp-nick').text(), res:resTxt, mode: "PvP", date: new Date().toLocaleDateString()});
            } else {
                db.ref('users/'+auth.currentUser.uid).update({rBot: Math.max(0, (userData.rBot||100)+(isWin?5:-6))});
                db.ref('users/'+auth.currentUser.uid+'/archive').push({opp:$('#opp-nick').text(), res:resTxt, mode: "–ë–æ—Ç", date: new Date().toLocaleDateString()});
                alert(resTxt); showScreen('menu-screen');
            }
        }

        function startBot(n, lvl) { 
            isPvP=false; gameActive=true; myColor='w'; botLevel = lvl;
            showScreen('game-screen'); $('#opp-nick').text(n);
            mySec = 600; oppSec = 600; startT();
            $('#game-controls').html(`<button class="btn" onclick="handleEnd(false,false)">üè≥Ô∏è –ó–î–ê–¢–ò–°–Ø (-6)</button>`);
            initBoard(); 
        }

        function makeBotMove() { 
            let moves = game.moves();
            if(moves.length === 0) return;
            let move;
            if(botLevel === 0) move = moves[Math.floor(Math.random() * moves.length)];
            else if(botLevel === 1) move = moves.find(m => m.includes('x')) || moves[Math.floor(Math.random() * moves.length)];
            else {
                let capture = moves.find(m => m.includes('x') && (m.includes('Q') || m.includes('R')));
                move = capture || moves.find(m => m.includes('x')) || moves[0];
            }
            game.move(move); board.position(game.fen());
            if(game.game_over()) handleEnd();
        }

        function showLB() {
            db.ref('users').once('value', s => {
                let users = Object.values(s.val() || {});
                let pvp = [...users].sort((a,b)=>b.rPvP-a.rPvP).slice(0,5).map((u,i)=>`${i+1}. ${u.nick}: ${u.rPvP}`).join("\n");
                let bot = [...users].sort((a,b)=>b.rBot-a.rBot).slice(0,5).map((u,i)=>`${i+1}. ${u.nick}: ${u.rBot}`).join("\n");
                alert("üèÜ PvP:\n"+pvp+"\n\nü§ñ –ë–æ—Ç–∏:\n"+bot);
            });
        }

        function fmt(s) { if(s<0) s=0; return Math.floor(s/60).toString().padStart(2,'0')+":"+(s%60).toString().padStart(2,'0'); }
        function renderArchive() {
            let h = "";
            if(userData.archive) Object.values(userData.archive).reverse().forEach(i => {
                h += `<div style="padding:8px; border-bottom:1px solid #222; display:flex; justify-content:space-between;"><span>${i.date} | ${i.mode}</span> <b>${i.res}</b></div>`;
            });
            $('#archive-list').html(h || "–ü–æ—Ä–æ–∂–Ω—å–æ");
        }
    </script>
</body>
</html>